
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://remyfp.github.io/CLT_BaseModel_Docs/math_flu_components/">
      
      
        <link rel="prev" href="../math_transitions/">
      
      
        <link rel="next" href="../flu_input_requirements/">
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>MetroFluSim Mathematical Formulation - City-level Transmission Toolkit</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0253249f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#metroflusim-mathematical-formulation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="City-level Transmission Toolkit" class="md-header__button md-logo" aria-label="City-level Transmission Toolkit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            City-level Transmission Toolkit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MetroFluSim Mathematical Formulation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="City-level Transmission Toolkit" class="md-nav__button md-logo" aria-label="City-level Transmission Toolkit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    City-level Transmission Toolkit
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CLT Toolkit
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            CLT Toolkit
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../math_transitions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stochastic Transitions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    MetroFluSim
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            MetroFluSim
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    MetroFluSim Mathematical Formulation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    MetroFluSim Mathematical Formulation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#flu-model-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      Flu model: diagram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flu-model-deterministic-differential-equations" class="md-nav__link">
    <span class="md-ellipsis">
      Flu model: deterministic differential equations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flu model: deterministic differential equations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#population-level-immunity" class="md-nav__link">
    <span class="md-ellipsis">
      Population-level immunity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compartment-equations" class="md-nav__link">
    <span class="md-ellipsis">
      Compartment equations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flu-model-travel-model" class="md-nav__link">
    <span class="md-ellipsis">
      Flu model: travel model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flu model: travel model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exposure-intensity" class="md-nav__link">
    <span class="md-ellipsis">
      Exposure intensity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contact-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      Contact matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-travel-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Other travel parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flu-model-discretized-stochastic-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Flu model: discretized stochastic implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-model-discretized-stochastic-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      General model: discretized stochastic implementation
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flu_input_requirements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Math-to-Code Input Mappings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Code API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Code API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../clt_base_package_reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLT Toolkit API Reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flu_components_reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flu Core API Reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Python for Modelers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Python for Modelers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python_resources.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    None
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="metroflusim-mathematical-formulation">MetroFluSim Mathematical Formulation</h1>
<p><span style="display: none;">
<span class="arithmatex">\(\def\rateRtoS{\sigma^{R\rightarrow S}}\)</span>
<span class="arithmatex">\(\def\rateEtoI{\sigma^{E \rightarrow [IP, IA]}}\)</span>
<span class="arithmatex">\(\def\rateIPtoIS{\sigma^{IP \rightarrow [ISR, ISH]}}\)</span>
<span class="arithmatex">\(\def\rateIStoR{\gamma^{IS\rightarrow R}}\)</span>
<span class="arithmatex">\(\def\rateISRtoR{\gamma^{ISR\rightarrow R}}\)</span>
<span class="arithmatex">\(\def\rateIStoH{\sigma^{IS\rightarrow H}}\)</span>
<span class="arithmatex">\(\def\rateISHtoH{\sigma^{ISH\rightarrow [HR, HD]}}\)</span>
<span class="arithmatex">\(\def\rateHtoD{\sigma^{H\rightarrow D}}\)</span>
<span class="arithmatex">\(\def\rateHRtoR{\gamma^{HR\rightarrow R}}\)</span>
<span class="arithmatex">\(\def\rateHDtoD{\sigma^{HD\rightarrow D}}\)</span>
<span class="arithmatex">\(\def\rateIAtoR{\gamma^{IA\rightarrow R}}\)</span>
<span class="arithmatex">\(\def\rateHtoR{\gamma^{H\rightarrow R}}\)</span>
<span class="arithmatex">\(\def\totalforceofinfection{\lambda^{(\ell), \text{total}}_{a}(t)}\)</span>
<span class="arithmatex">\(\def\propIA{\pi^{IA}}\)</span>
<span class="arithmatex">\(\def\propH{\pi^H}\)</span>
<span class="arithmatex">\(\def\propD{\pi^D}\)</span>
<span class="arithmatex">\(\def\adjustedpropH{\tilde{\pi}^H}\)</span>
<span class="arithmatex">\(\def\adjustedpropD{\tilde{\pi}^D}\)</span>
<span class="arithmatex">\(\def\proptravelelltok{p^{\ell \rightarrow k}}\)</span>
<span class="arithmatex">\(\def\propdaytravelktoell{p^{k \rightarrow \ell}}\)</span>
<span class="arithmatex">\(\def\LambdaIlocagerisktime{\Lambda^{(\ell), I}_{a,r}(t)}\)</span>
<span class="arithmatex">\(\def\LambdaHlocagerisktime{\Lambda^{(\ell), H}_{a,r}(t)}\)</span>
<span class="arithmatex">\(\def\LambdaDlocagerisktime{\Lambda^{(\ell), D}_{a,r}(t)}\)</span>
<span class="arithmatex">\(\def\locationell{^{(\ell)}}\)</span>
<span class="arithmatex">\(\def\locationk{^{(k)}}\)</span>
<span class="arithmatex">\(\def\locagerisk{\locationell_{a, r}}\)</span>
<span class="arithmatex">\(\def\locagerisktime{\locagerisk(t)}\)</span>
<span class="arithmatex">\(\def\agetime{_a(t)}\)</span>
<span class="arithmatex">\(\def\agerisk{_{a, r}}\)</span>
<span class="arithmatex">\(\def\agerisktime{_{a, r}(t)}\)</span>
<span class="arithmatex">\(\def\ageprimeriskprime{_{a^\prime, r^\prime}}\)</span>
<span class="arithmatex">\(\def\locageprimeriskprime{\locationell_{a^\prime, r^\prime}}\)</span>
<span class="arithmatex">\(\def\Nlocagerisk{N\locationell_{a,r}}\)</span>
<span class="arithmatex">\(\def\effectiveNlocagerisktime{\tilde{N}\locationell_{a,r}(t)}\)</span>
<span class="arithmatex">\(\def\effectiveNlocageprimeriskprimetime{\tilde{N}\locationell_{a^\prime,r^\prime}(t)}\)</span>
<span class="arithmatex">\(\def\multipliersymptom{h_{\text{symp}}}\)</span>
<span class="arithmatex">\(\def\tvarloc{y^{(\ell)}}\)</span>
<span class="arithmatex">\(\def\jointtvarloc{y^{(\ell) *}}\)</span>
<span class="arithmatex">\(\def\simstate{\boldsymbol{\Xi}_t}\)</span>
<span class="arithmatex">\(\def\agegroups{\mathcal A}\)</span>
<span class="arithmatex">\(\def\riskgroups{\mathcal R}\)</span>
<span class="arithmatex">\(\def\numagegroups{\lvert \agegroups \rvert}\)</span>
<span class="arithmatex">\(\def\numriskgroups{\lvert \riskgroups \rvert}\)</span>
<span class="arithmatex">\(\def\poik{\text{POI}(k)}\)</span>
<span class="arithmatex">\(\def\poiell{\text{POI}(\ell)}\)</span>
</span></p>
<p>The mathematical framework is inspired by the immunoSEIRS model of the Meyers Lab (see <a href="https://www.researchgate.net/publication/375193467_Scenario_Projections_for_SARS-CoV-2_Influenza_and_RSV_Burden_in_the_US_2023-2024">Bi and Bandekar et al. 2023</a>, <a href="https://repositories.lib.utexas.edu/server/api/core/bitstreams/da7bb152-3343-4135-86e3-040546d6e5b5/content">Bi et al. 2022</a> and <a href="https://repositories.lib.utexas.edu/items/e8d50517-6e78-488b-8c95-8c1138d90c28">Bouchnita et al. 2021</a> for some related recent publications).</p>
<p>Please note that the MetroFluSim model requires extensive notation -- please review the entirety of each section for provided definitions.</p>
<h2 id="flu-model-diagram">Flu model: diagram</h2>
<p><img alt="flu_model_diagram" src="../figs/flu_model_diagram.png" /></p>
<h2 id="flu-model-deterministic-differential-equations">Flu model: deterministic differential equations</h2>
<p>We start off with common indices and arguments:
- <span class="arithmatex">\(t \in \mathbb N\)</span>: current simulation day
- <span class="arithmatex">\(\ell\)</span>: location, i.e. subpopulation, <span class="arithmatex">\(\mathcal L\)</span>: set of all locations/subpopulations
- <span class="arithmatex">\(a\)</span>: age group, <span class="arithmatex">\(\agegroups\)</span>: set of all age groups
- <span class="arithmatex">\(r\)</span>: risk group, <span class="arithmatex">\(\riskgroups\)</span>: set of all risk groups
- <span class="arithmatex">\(i\)</span>: type of immunity-inducing event, <span class="arithmatex">\(\mathcal{I} := \left\{\text{infection}, \text{vaccine}\right\}\)</span>: the set of all types of immunity-inducing events: infection and vaccination, respectively.</p>
<h3 id="population-level-immunity">Population-level immunity</h3>
<p>For each <span class="arithmatex">\(\ell \in \mathcal L\)</span>, <span class="arithmatex">\(a \in \agegroups\)</span>, <span class="arithmatex">\(r \in \riskgroups\)</span>:</p>
<div class="arithmatex">\[\begin{align*}
\frac{dM\locationell\agerisktime}{dt} &amp;= \frac{\rateRtoS(t) R\locagerisktime}{N\locationell_{a, r}} \cdot (1 - oM\locationell\agerisktime - o_v MV\locationell\agerisktime) - wM\locationell\agerisktime \tag{M1} \\
\frac{dMV\locationell\agerisktime}{dt} &amp;= \frac{V\locationell\agerisk(t - \delta)}{N\locationell\agerisk} - w_v MV\locationell\agerisktime \tag{M2}
\end{align*}\]</div>
<p>where</p>
<ul>
<li><span class="arithmatex">\(\rateRtoS\)</span>: rate at which recovered individuals become susceptible, so that <span class="arithmatex">\(1/\rateRtoS\)</span> is the average number of days a person is totally immune from reinfection until being susceptible again.</li>
<li><span class="arithmatex">\(V\locationell\agerisktime\)</span>: number of vaccine doses administered at time <span class="arithmatex">\(t\)</span> to individuals residing in location <span class="arithmatex">\(\ell \in \mathcal L\)</span> in age-risk group <span class="arithmatex">\(a\)</span>, <span class="arithmatex">\(r\)</span>.</li>
<li><span class="arithmatex">\(o\)</span>, <span class="arithmatex">\(o_v\)</span>: positive constants modeling the saturation of antibody production in individuals who have infection-induced immunity and vaccination-induced immunity, respectively.</li>
<li><span class="arithmatex">\(\delta\)</span>: number of days after dose for vaccine to become effective.</li>
<li><span class="arithmatex">\(w\)</span>: rate at which infection-induced immunity wanes.</li>
<li><span class="arithmatex">\(w_V\)</span>: rate at which vaccine-induced immunity wanes.</li>
</ul>
<h3 id="compartment-equations">Compartment equations</h3>
<p>Note that the following are all <span class="arithmatex">\(\numagegroups \times \numriskgroups \times \lvert \mathcal I \rvert\)</span> matrices:</p>
<ul>
<li><strong><span class="arithmatex">\(\boldsymbol{K}^I = [\boldsymbol{K}^I, \boldsymbol{K}^I_{V}]\)</span></strong>: reduction in infection risk from given immunity-inducing event.  </li>
<li><strong><span class="arithmatex">\(\boldsymbol{K}^{H} = [\boldsymbol{K}^H, \boldsymbol{K}^H_{V}]\)</span></strong>: reduction in hospitalization risk from given immunity-inducing event.  </li>
<li><strong><span class="arithmatex">\(\boldsymbol{K}^D = [\boldsymbol{K}^D, \boldsymbol{K}^D_{V}]\)</span></strong>: reduction in death risk from given immunity-inducing event.  </li>
<li><strong><span class="arithmatex">\(\boldsymbol{M}\locationell = \boldsymbol{M}\locationell(t) = [\boldsymbol{M}\locationell(t), \boldsymbol{M}\locationell_{V}(t)]\)</span></strong>: location <span class="arithmatex">\(\ell \in \mathcal L\)</span> population-level immunity.  </li>
</ul>
<p>To simplify notation, we have the following terms that characterize the effect of population-level immunities for a given subpopulation <span class="arithmatex">\(\ell\)</span>, age <span class="arithmatex">\(a\)</span>, and risk <span class="arithmatex">\(r\)</span>:</p>
<div class="arithmatex">\[\begin{align*}
\LambdaIlocagerisktime &amp;= \left[\frac{\boldsymbol{K_{a,r}^{I}}}{\boldsymbol{1}_{\lvert \mathcal L \rvert \times 1} - \boldsymbol{K_{a,r}^{I}}}\right]^T \boldsymbol{M_{a,r}\locationell(t)} \tag{I1} \\
\LambdaHlocagerisktime &amp;= \left[\frac{\boldsymbol{K_{a,r}^{H}}}{\boldsymbol{1}_{\lvert \mathcal L \rvert \times 1} - \boldsymbol{K_{a,r}^{H}}}\right]^T \boldsymbol{M_{a,r}\locationell(t)} \tag{I2} \\
\LambdaDlocagerisktime &amp;= \left[\frac{\boldsymbol{K_{a,r}^{D}}}{\boldsymbol{1}_{\lvert \mathcal L \rvert \times 1} - \boldsymbol{K_{a,r}^{D}}}\right]^T \boldsymbol{M_{a,r}\locationell(t)} \tag{I3}
\end{align*}\]</div>
<p>where <span class="arithmatex">\(\boldsymbol{1}_{\lvert \mathcal L \rvert \times 1}\)</span> is an <span class="arithmatex">\(\lvert \mathcal L \rvert \times 1\)</span> vector of <span class="arithmatex">\(1\)</span>'s and the fraction notation indicates element-wise division. </p>
<p>For each <span class="arithmatex">\(\ell \in \mathcal L\)</span>, <span class="arithmatex">\(a \in \agegroups\)</span>, <span class="arithmatex">\(r \in \riskgroups\)</span>, we have the following equations that characterize transitions between compartments:</p>
<div class="arithmatex">\[\begin{align}
\frac{dS\locagerisktime}{dt} &amp;= \underbrace{\rateRtoS R\locagerisktime}_{\text{$R$ to $S$}} 
-\underbrace{S\locagerisktime \frac{\beta\locationell(t) \cdot \totalforceofinfection}{\left(1 + \LambdaIlocagerisktime\right)}}_{\text{$S$ to $E$}} \tag{C1} \\[1.5em]
\frac{dE\locagerisktime}{dt} &amp;= \underbrace{S\locagerisktime \frac{\beta\locationell(t) \cdot \totalforceofinfection}{\left(1 + \LambdaIlocagerisktime\right)}}_{\text{$S$ to $E$}} - \underbrace{\rateEtoI (1-\propIA) E\locagerisktime}_{\text{$E$ to $IP$}} - \underbrace{\rateEtoI \propIA E\locagerisktime}_{\text{$E$ to $IA$}} \tag{C2} \\[1.5em]
\frac{dIP\locagerisktime}{dt} &amp;= \underbrace{\rateEtoI (1-\propIA) E\locagerisktime}_{\text{$E$ to $IP$}} - \underbrace{\rateIPtoIS IP\locagerisktime}_{\text{$IP$ to $ISR$ and $ISH$}} \tag{C3} \\[1.5em]
\frac{dISR\locagerisktime}{dt} &amp;= \underbrace{\left(1-\frac{\pi^H}{1 + \LambdaHlocagerisktime}\right)\rateIPtoIS IP\locagerisktime}_{\text{$IP$ to $ISR$}} 
- \underbrace{\rateISRtoR ISR\locagerisktime}_{\text{$ISR$ to $R$}} \tag{C4} \\[1.5em]
\frac{dISH\locagerisktime}{dt} &amp;= \underbrace{\frac{\pi^H \rateIPtoIS IP\locagerisktime}{1 + \LambdaHlocagerisktime}}_{\text{$IP$ to $ISH$}} - \underbrace{\rateISHtoH ISH\locagerisktime}_{\text{$ISH$ to $HR$ and $HD$}} \tag{C5} \\[1.5em]
\frac{dIA\locagerisktime}{dt} &amp;= \underbrace{\rateEtoI \propIA E\locagerisktime}_{\text{$E$ to $IA$}} 
- \underbrace{\rateIAtoR IA\locagerisktime}_{\text{$IA$ to $R$}} \tag{C6} \\[1.5em]
\frac{dHR\locagerisktime}{dt} &amp;= \underbrace{\left(1-\frac{\pi^D_{a, r}}{1 + \LambdaDlocagerisktime}\right) \rateISHtoH ISH\locagerisktime}_{\text{$ISH$ to $HR$}} - \underbrace{\rateHRtoR HR\locagerisktime}_{\text{$HR$ to $R$}} \tag{C7} \\[1.5em]
\frac{dHD\locagerisktime}{dt} &amp;= \underbrace{\frac{\pi^D_{a, r} \rateISHtoH ISH\locagerisktime}{1 + \LambdaDlocagerisktime}}_{\text{$ISH$ to $HD$}} - \underbrace{\rateHDtoD HD\locagerisktime}_{\text{$HD$ to $D$}} \tag{C8} \\[1.5em]
\frac{dR\locagerisktime}{dt} &amp;= \underbrace{\rateISRtoR ISR\locagerisktime}_{\text{$ISR$ to $R$}} + \underbrace{\rateIAtoR IA\locagerisktime}_{\text{$IA$ to $R$}} + \underbrace{\rateHRtoR HR\locagerisktime}_{\text{$HR$ to $R$}}
- \underbrace{\rateRtoS R\locagerisktime}_{\text{$R$ to $S$}} \tag{C9} \\[1.5em]
\frac{dD\locagerisktime}{dt} &amp;= \underbrace{\rateHDtoD HD\locagerisktime}_{\text{$HD$ to $D$}}. \tag{C10}
\end{align}\]</div>
<p>where</p>
<ul>
<li>The <span class="arithmatex">\(\lambda\)</span>-terms are location/subpopulation mixing terms that we define in the next section on the travel model. </li>
<li><span class="arithmatex">\(\boldsymbol{N}\locationell\)</span>: <span class="arithmatex">\(\numagegroups \times \numriskgroups\)</span> matrix corresponding to total population in location <span class="arithmatex">\(\ell \in \mathcal L\)</span>, where element <span class="arithmatex">\(N\locagerisk\)</span> is the total population of age group <span class="arithmatex">\(a\)</span> and risk group <span class="arithmatex">\(\ell\)</span> in location <span class="arithmatex">\(\ell\)</span>.</li>
<li><span class="arithmatex">\(\beta\locationell(t) = \beta\locationell_0 (1 + q(t))\)</span>: time-dependent transmission rate per day for individuals residing in location <span class="arithmatex">\(\ell \in \mathcal L\)</span>. </li>
<li><span class="arithmatex">\(q(t) = \xi \cdot \exp^{-180 * h(t)}\)</span>: humidity adjustment, where <span class="arithmatex">\(\xi\)</span> is the humidity impact factor and <span class="arithmatex">\(h(t)\)</span> is absolute humidity. This formula is taken from <a href="https://journals.plos.org/plosbiology/article?id=10.1371/journal.pbio.1000316#s4">this paper</a>.</li>
<li><span class="arithmatex">\(\propIA\)</span>: proportion exposed who are completely asymptomatic when infectious.</li>
<li><span class="arithmatex">\(r_{IP}\)</span>, <span class="arithmatex">\(r_{IA}\)</span>: relative infectiousness (compared to infected symptomatic people) of infected presymptomatic and infected asymptomatic people respectively. </li>
<li><span class="arithmatex">\(\rateISRtoR, \rateHRtoR, \rateIAtoR\)</span>: recovery rates for infected symptomatic (<span class="arithmatex">\(ISR\)</span>),  hospital (<span class="arithmatex">\(HR\)</span>), and infected asymptomatic (<span class="arithmatex">\(IA\)</span>) compartments respectively, so that <span class="arithmatex">\(1/\gamma\)</span> is the average number of days it takes for an infected person not in the hospital to recover, and <span class="arithmatex">\(1/\rateHtoR\)</span> is analogous, but for an infected person in the hospital. </li>
<li><span class="arithmatex">\(\rateEtoI\)</span>: infection rate (both exposed to infected presymptomatic transition rate and exposed to infected asymptomatic transition rate), so that <span class="arithmatex">\(1/\rateEtoI\)</span> is the average number of days after exposure before a person becomes infectious.</li>
<li><span class="arithmatex">\(\rateIPtoIS\)</span>: infected presymptomatic to infected symptomatic (both <span class="arithmatex">\(ISR\)</span> and <span class="arithmatex">\(ISH\)</span>) transition rate, so that <span class="arithmatex">\(1/\rateIPtoIS\)</span> is the average number of days that an infected person is presymptomatic before becoming symptomatic. </li>
<li><span class="arithmatex">\(\rateISHtoH\)</span>: hospitalization rate (infected to hospital transition rate), so that <span class="arithmatex">\(1/\rateISHtoH\)</span> is the average number of days a person is infected before going to the hospital.</li>
<li><span class="arithmatex">\(\rateHDtoD\)</span>: death rate from hospital, so that <span class="arithmatex">\(1/\rateHDtoD\)</span> is the average number of days a person spends in the hospital before dying.</li>
</ul>
<!-- - $\boldsymbol{\adjustedpropH}$, where $\adjustedpropH_{a, r} = \frac{\propH_{a, r}\rateIStoR}{\rateIStoH - \propH_{a, r}(\rateIStoH-\rateIStoR)}$: adjusted proportion hospitalized based on age-risk group $a, r$ group actually used in model -- this adjustment is necessary to ensure actual proportion hospitalized recapitulates $[\propH_{a, r}]$. -->
<ul>
<li><span class="arithmatex">\(\boldsymbol{\propH}\)</span>: <span class="arithmatex">\(\numagegroups \times \numriskgroups\)</span> proportion hospitalized based on age-risk group <span class="arithmatex">\(a, r\)</span>.</li>
</ul>
<!-- - $\boldsymbol{\adjustedpropD}$, where $\adjustedpropD_{a, r} = \frac{\propD_{a, r} \rateHtoR}{\rateHtoD - \propD_{a, r} (\rateHtoD-\rateHtoR)}$: adjusted in-hospital mortality rate (as in, proportion who die in the hospital based on age group) actually used in model -- this adjustment is necessary to ensure actual proportion who die in the hospital recapitulates $[\propD_{a, r} ]$. -->
<ul>
<li><span class="arithmatex">\(\boldsymbol{\propD}\)</span>: <span class="arithmatex">\(\numagegroups \times \numriskgroups\)</span> in-hospital mortality rate (proportion who die based on age-risk group <span class="arithmatex">\(a, r\)</span>).</li>
</ul>
<h2 id="flu-model-travel-model">Flu model: travel model</h2>
<h3 id="exposure-intensity">Exposure intensity</h3>
<p>For each <span class="arithmatex">\(\ell \in \mathcal L\)</span>, <span class="arithmatex">\(k \in \mathcal L \setminus \{\ell\}\)</span>, <span class="arithmatex">\(a \in \agegroups\)</span>, we have</p>
<div class="arithmatex">\[
\totalforceofinfection = \lambda^{(\ell), \text{local}}\agetime + \lambda^{(\ell), \text{visitors}}\agetime + \lambda^{(\ell), \text{residents traveling}}\agetime. \tag{T1}
\]</div>
<p>This can loosely can be interpreted as exposure intensity: the (weighted) proportion of the population that interacts with <span class="arithmatex">\(\ell,a\)</span> individuals that are infectious. </p>
<p>The decompositions model the following phenomenon:</p>
<ul>
<li><span class="arithmatex">\(\lambda^{(\ell), \text{local}}\agetime\)</span>: rate at which individuals in location <span class="arithmatex">\(\ell\)</span> get exposed to infected people who live in location <span class="arithmatex">\(\ell\)</span> (this contact occurs in location <span class="arithmatex">\(\ell\)</span>).</li>
<li><span class="arithmatex">\(\lambda^{(\ell), \text{visitors from } k}\agetime\)</span>: rate at which individuals in location <span class="arithmatex">\(\ell\)</span> get exposed to infected people who live in location <span class="arithmatex">\(k\)</span> but travel to location <span class="arithmatex">\(\ell\)</span> (this contact occurs in location <span class="arithmatex">\(\ell\)</span>).</li>
<li><span class="arithmatex">\(\lambda^{(\ell), \text{residents traveling to } k}\agetime\)</span>: rate at which individuals in location <span class="arithmatex">\(\ell\)</span> get exposed to infected people who live in location <span class="arithmatex">\(k\)</span>, due to individuals who live in location <span class="arithmatex">\(\ell\)</span> traveling to location <span class="arithmatex">\(k\)</span> (this contact occurs in location <span class="arithmatex">\(k\)</span>).</li>
</ul>
<p>Note that we assume this exposure intensity is the same for a given age group regardless of risk group, so we do not have the <span class="arithmatex">\(r\)</span>-subscript here.</p>
<p>Specifically, we have</p>
<div class="arithmatex">\[\begin{align*}
\lambda^{(\ell), \text{local}}\agetime &amp;= \psi_a \left(1 - m_a \sum_{k \in \mathcal L \setminus \{\ell\}} \proptravelelltok \right) \cdot \sum \limits_{a^\prime \in \agegroups} \phi\locationell_{a,a^\prime}(t) \frac{\texttt{I_weighted}\locationell_{a^\prime}(t)}{\sum_{r^\prime \in \riskgroups} \effectiveNlocageprimeriskprimetime} \tag{T2} \\[1.5em]
\lambda^{(\ell), \text{visitors}}\agetime &amp;= \sum_{k \in \mathcal L \setminus \{\ell\}} \underbrace{\left(\psi_a \cdot \propdaytravelktoell \cdot \sum\limits_{a^\prime \in \agegroups} m_{a^\prime}(t) \cdot \phi\locationell_{a, a^\prime}(t) \frac{\texttt{I_weighted}\locationk_{a^\prime}(t)}{\sum_{r^\prime \in \riskgroups} \effectiveNlocageprimeriskprimetime}\right)}_{\text{Each summand: } \lambda^{(\ell), \text{visitors from } k}\agetime} \tag{T3} \\[1.5em]
\lambda_{a,r}^{(\ell), \text{residents traveling}}(t) &amp;= \sum_{k \in \mathcal L \setminus \{\ell\}}  \underbrace{\left(\psi_a \cdot \proptravelelltok  \cdot m_a \cdot \sum\limits_{a^\prime \in \agegroups} \phi\locationell_{a, a^\prime}(t) \frac{\texttt{I_weighted}\locationk_{a^\prime}(t)}{\sum_{r^\prime \in \riskgroups} \tilde{N}^{(k)}_{a^\prime, r^\prime} (t)}\right)}_{\text{Each summand: } \lambda\agerisk^{(\ell), \text{residents traveling to } k}(t)} \tag{T4}
\end{align*}\]</div>
<p>where</p>
<div class="arithmatex">\[
\texttt{I_weighted}\locationell_{a^\prime}(t) := \sum_{r^\prime \in \riskgroups} \left[ISR\locationell\ageprimeriskprime(t) + ISH\locationell\ageprimeriskprime(t) + r_{IP} IP\locationell\ageprimeriskprime(t) + r_{IA} IA\locationell\ageprimeriskprime(t)\right] \tag{T5}
\]</div>
<p>and where</p>
<div class="arithmatex">\[\begin{align*}
\effectiveNlocagerisktime &amp;= \Nlocagerisk + m_a \cdot \sum_{k \in \mathcal L \setminus \{\ell\}} \propdaytravelktoell \cdot (N^{(k)}_{a, r} - HR^{(k)}_{a,r}(t) - HD^{(k)}_{a,r}(t)) \\ &amp;\quad\quad\quad - m_a \cdot \sum_{k \in \mathcal L \setminus \{\ell\}} \proptravelelltok  \cdot (N\locagerisk - HR\locationell_{a,r}(t) - HD\locationell_{a,r}(t)) \tag{T6}
\end{align*}\]</div>
<p>is the effective population in location <span class="arithmatex">\(\ell \in \mathcal L\)</span> and age-risk group <span class="arithmatex">\(a \in \agegroups\)</span>, <span class="arithmatex">\(r \in \riskgroups\)</span> at time <span class="arithmatex">\(t\)</span>.</p>
<h3 id="contact-matrix">Contact matrix</h3>
<p>The contact matrix is defined as</p>
<ul>
<li><span class="arithmatex">\(\phi_{a, a^\prime}\locationell(t)\)</span>: the number of contacts that individuals in age group <span class="arithmatex">\(a \in \agegroups\)</span> residing in location <span class="arithmatex">\(\ell \in \mathcal L\)</span> have with other individuals (regardless of location) in age group <span class="arithmatex">\(a^\prime \in \agegroups\)</span> on day <span class="arithmatex">\(t\)</span>.</li>
</ul>
<p>Let <span class="arithmatex">\(\phi^{(\ell), \text{total}}\)</span>, <span class="arithmatex">\(\phi^{(\ell), \text{work}}\)</span>, and <span class="arithmatex">\(\phi^{(\ell), \text{school}}\)</span> represent the total contact matrix, school contact matrix, and work contact matrix, respectively for subpopulation <span class="arithmatex">\(\ell\)</span>.</p>
<p>Then the contact matrix for the subpopulation at time <span class="arithmatex">\(t\)</span> is
$$
\phi^{(\ell)}(t) := \phi^{(\ell), \text{total}} - (1 - d_{\text{work}}(t)) \phi^{(\ell), \text{work}} - (1 - d_{\text{school}}(t)) \phi^{(\ell), \text{school}}
$$
where <span class="arithmatex">\(d_{\text{work}}(t)\)</span> is <span class="arithmatex">\(1\)</span> if the real-world date corresponding to simulation time <span class="arithmatex">\(t\)</span> is a work day and <span class="arithmatex">\(0\)</span> otherwise, and <span class="arithmatex">\(d_{\text{school}}(t)\)</span> is defined analogously, but for school days.</p>
<h3 id="other-travel-parameters">Other travel parameters</h3>
<p>We have</p>
<ul>
<li><span class="arithmatex">\(\psi_a \in [0, 1]\)</span>: relative susceptibility of individuals in age group <span class="arithmatex">\(a \in \agegroups\)</span>.</li>
<li><span class="arithmatex">\(m_a\)</span>: a positive scalar modifying travel intensity depending on age <span class="arithmatex">\(a\)</span>.</li>
<li><span class="arithmatex">\(\propdaytravelktoell\)</span>: (on average) proportion of the day that a resident of <span class="arithmatex">\(k\)</span> spends traveling to location <span class="arithmatex">\(\ell \in \mathcal L\)</span>.</li>
</ul>
<p>Note that the arrows in <span class="arithmatex">\(\propdaytravelktoell\)</span> correspond to direction of travel (e.g. <span class="arithmatex">\(k \rightarrow \ell\)</span> represents residents of location <span class="arithmatex">\(k\)</span> traveling to location <span class="arithmatex">\(\ell\)</span>). The <span class="arithmatex">\(\propdaytravelktoell\)</span> values are calculated from mobility data, corresponding to</p>
<div class="arithmatex">\[
\propdaytravelktoell := \sum_{\poiell} c^{\poiell} \cdot v^{k \rightarrow \poiell} \tag{T7}
\]</div>
<p>where</p>
<ul>
<li><span class="arithmatex">\(c^{\poiell}\)</span>: average proportion of a day spent at <span class="arithmatex">\(\poiell\)</span>.</li>
<li><span class="arithmatex">\(v^{k \rightarrow \poiell}\)</span>: average number of visits per day per resident of <span class="arithmatex">\(k\)</span> to <span class="arithmatex">\(\poiell\)</span>.</li>
</ul>
<h2 id="flu-model-discretized-stochastic-implementation">Flu model: discretized stochastic implementation</h2>
<p>To actually implement/simulate this compartmental model, we discretize the deterministic differential equations and treat transitions between compartments as stochastic to model uncertainty. We extend the notation from the deterministic differential equations to capture the stochastic elements.</p>
<p>Let <strong><span class="arithmatex">\(\boldsymbol{\mathcal X}(t) = \left\{\boldsymbol{S}(t), \boldsymbol{E}(t), \boldsymbol{IA}(t), \boldsymbol{IP}(t), \boldsymbol{ISR}(t), \boldsymbol{ISH}(t), \boldsymbol{HR}(t), \boldsymbol{HD}(t), \boldsymbol{R}(t), \boldsymbol{D}(t), \boldsymbol{M}(t), \boldsymbol{MV}(t), q(t), \boldsymbol{\phi}(t), V\locationell(t)\right\}\)</span></strong> be the "simulation state" at time <span class="arithmatex">\(t\)</span>. <strong><span class="arithmatex">\(\boldsymbol{\mathcal X}(t)\)</span></strong> is a set of matrices. </p>
<p>Let <strong><span class="arithmatex">\(\boldsymbol{\Theta}\)</span></strong> be the set of fixed parameters. </p>
<p>Then given initial state <span class="arithmatex">\(\boldsymbol{\mathcal X}_0 = \boldsymbol{\mathcal X}(0)\)</span>, we can formulate our discretized stochastic implementation as</p>
<div class="arithmatex">\[
\boldsymbol{\mathcal X}(t + \Delta t) = \boldsymbol{\mathcal X}(t) + f\left(\boldsymbol{\mathcal X}(t), \Delta t, \omega; \boldsymbol{\Theta}\right) \quad \text{for} \quad t \ge 0,
\]</div>
<p>where <span class="arithmatex">\(f\)</span> is parametrized by <span class="arithmatex">\(\boldsymbol{\Theta}\)</span>, and depends on the step size of discretization <span class="arithmatex">\(\Delta t\)</span> and a sample path <span class="arithmatex">\(\omega\)</span>. We assume that each sample path <span class="arithmatex">\(\omega\)</span> is realized from a random process that does not depend on <span class="arithmatex">\(\boldsymbol{\mathcal X}(t)\)</span> or <span class="arithmatex">\(\Delta t\)</span> for each <span class="arithmatex">\(t\)</span>. When we are discussing a single model with a fixed set of parameters <span class="arithmatex">\(\boldsymbol{\Theta}\)</span>, we drop the <span class="arithmatex">\(\boldsymbol{\Theta}\)</span> notation for simplicity.  </p>
<p>Now we formulate how we implement discretized stochastic transitions. We assume that <span class="arithmatex">\(q(t)\)</span>, <strong><span class="arithmatex">\(\boldsymbol{\phi}(t)\)</span></strong>, and <span class="arithmatex">\(V\locationell(t)\)</span>  are updated deterministically according to some "schedule."  </p>
<p>We model stochastic transitions between compartments using "transition variables." Transition variables correspond to incoming and outgoing flows of epidemiological compartments (see the compartment equations above). </p>
<p>Below we formulate the discretized stochastic transitions. Note that the population-level immunity variables behave as aggregate epidemiological metrics. They are deterministic functions of the simulation state and transitions between compartments.</p>
<blockquote>
<p><strong>IMPORTANT NOTE_: all <span class="arithmatex">\(y\)</span> and <span class="arithmatex">\(y^*\)</span>-variables depend on <span class="arithmatex">\(\left(\boldsymbol{\mathcal X}(t), \Delta t, \omega\right)\)</span>. For notation simplicity, we define <span class="arithmatex">\(\simstate := \left(\boldsymbol{\mathcal X}(t), \Delta t, \omega\right)\)</span> and write <span class="arithmatex">\(y\)</span> and <span class="arithmatex">\(y^*\)</span>-variables as functions of <span class="arithmatex">\(\simstate\)</span>.</strong></p>
</blockquote>
<p>For each <span class="arithmatex">\(\ell \in \mathcal L\)</span>, <span class="arithmatex">\(a \in \agegroups\)</span>, and <span class="arithmatex">\(r \in \riskgroups\)</span>:</p>
<div class="arithmatex">\[\begin{align}
M_{a, r}\locationell(t + \Delta t) &amp;= M\locationell\agerisktime + \frac{dM\locationell\agerisktime}{dt} \cdot \Delta t \\
MV_{a,r}\locationell(t + \Delta t) &amp;= MV\agerisktime\locationell + \frac{dMV\agerisktime\locationell}{dt} \cdot \Delta t \\
S\locagerisk(t + \Delta t) &amp;= S_{a, r}\locationell(t) + \underbrace{\tvarloc_{R\rightarrow S, a, r}(\Xi_t)}_{\text{$R$ to $S$}} - \underbrace{\tvarloc_{S\rightarrow E, a, r}(\Xi_t)}_{\text{$S$ to $E$}} \\
E\locagerisk(t + \Delta t) &amp;= E_{a, r}\locationell(t) + \underbrace{\tvarloc_{S\rightarrow E, a, r}(\Xi_t)}_{\text{$S$ to $E$}} - \underbrace{\jointtvarloc_{E\rightarrow IP, a, r}(\Xi_t)}_{\text{$E$ to $IP$}} - \underbrace{\jointtvarloc_{E\rightarrow IA, a, r}(\Xi_t)}_{\text{$E$ to $IA$}} \\
IP\locagerisk(t + \Delta t) &amp;= IP\locagerisktime + \underbrace{\jointtvarloc_{E\rightarrow IP, a, r}(\Xi_t)}_{\text{$E$ to $IP$}} - \underbrace{\tvarloc_{IP \rightarrow ISR, a, r}(\Xi_t)}_{\text{$IP$ to $ISR$}} - \underbrace{\tvarloc_{IP \rightarrow ISH, a, r}(\Xi_t)}_{\text{$IP$ to $ISH$}} \\
IA_{a, r}\locationell(t + \Delta t) &amp;= IA_{a, r}\locationell(t) + \underbrace{\jointtvarloc_{E\rightarrow IA, a, r}(\Xi_t)}_{\text{$E$ to $IA$}} - \underbrace{\tvarloc_{IA \rightarrow R, a, r}(\Xi_t)}_{\text{$IA$ to $R$}} \\
ISR\locagerisk(t + \Delta t) &amp;= ISR_{a, r}\locationell(t) + \underbrace{\tvarloc_{IP \rightarrow ISR, a, r}(\Xi_t)}_{\text{$IP$ to $ISR$}} - \underbrace{\jointtvarloc_{ISR \rightarrow R, a, r}(\Xi_t)}_{\text{$ISR$ to $R$}} \\
ISH\locagerisk(t + \Delta t) &amp;= ISH_{a, r}\locationell(t) + \underbrace{\tvarloc_{IP \rightarrow ISH, a, r}(\Xi_t)}_{\text{$IP$ to $ISH$}} - \underbrace{\jointtvarloc_{ISH \rightarrow HR, a, r}(\Xi_t)}_{\text{$ISH$ to $HR$}} - \underbrace{\jointtvarloc_{ISH \rightarrow HD, a, r}(\Xi_t)}_{\text{$ISH$ to $HD$}} \\
HR\locagerisk(t + \Delta t) &amp;= HR_{a, r}\locationell(t) + \underbrace{\jointtvarloc_{ISH \rightarrow HR, a, r}(\Xi_t)}_{\text{$ISH$ to $HR$}} - \underbrace{\jointtvarloc_{HR\rightarrow R, a, r}(\Xi_t)}_{\text{$HR$ to $R$}} \\
HD\locagerisk(t + \Delta t) &amp;= HD_{a, r}\locationell(t) + \underbrace{\jointtvarloc_{ISH \rightarrow HD, a, r}(\Xi_t)}_{\text{$ISH$ to $HD$}} - \underbrace{\jointtvarloc_{HD\rightarrow D, a, r}(\Xi_t)}_{\text{$HD$ to $D$}} \\
R\locagerisk(t + \Delta t) &amp;= R_{a, r}\locationell(t) + \underbrace{\jointtvarloc_{IA \rightarrow R, a, r}(\Xi_t)}_{\text{$IA$ to $R$}} + \underbrace{\jointtvarloc_{ISR \rightarrow R, a, r}(\Xi_t)}_{\text{$ISR$ to $R$}} + \underbrace{\jointtvarloc_{HR\rightarrow R, a, r}(\Xi_t)}_{\text{$HR$ to $R$}} - \underbrace{\tvarloc_{R\rightarrow S, a, r}(\Xi_t)}_{\text{$R$ to $S$}} \\
D\locagerisk(t + \Delta t) &amp;= D_{a, r}\locationell(t) + \underbrace{\jointtvarloc_{HD\rightarrow D, a, r}(\Xi_t)}_{\text{$HD$ to $D$}}. 
\end{align}\]</div>
<blockquote>
<p><strong>IMPORTANT NOTE: the "<span class="arithmatex">\(*\)</span>" superscript indicates that the transition variable has a joint distribution with another transition variable. In general, if a compartment has more than one outgoing transition variable, these transition variables must be modeled jointly.</strong> </p>
</blockquote>
<p>Consider the two transitions out of the infected symptomatic compartment, for example. Given that a patient is infected and symptomatic, exactly one outcome occurs: they recover (from home) or they go to the hospital. Since one and only one of these outcomes must occur, we must model these two transition variables jointly. Joint distribution derivation details are provided in the next section on transition types.</p>
<p>Each transition variable depends on a "base count" and a "rate" (which both depend on the current state of the system). This decomposition is displayed in the table below. Note that these transitions are for a given location <span class="arithmatex">\(\ell \in \mathcal L\)</span>.</p>
<table>
<thead>
<tr>
<th>Transition</th>
<th>Transition variable</th>
<th>Base count</th>
<th>Rate</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="arithmatex">\(R\)</span> to <span class="arithmatex">\(S\)</span></td>
<td><span class="arithmatex">\(\tvarloc_{R \rightarrow S, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(R_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateRtoS\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(S\)</span> to <span class="arithmatex">\(E\)</span></td>
<td><span class="arithmatex">\(\tvarloc_{S \rightarrow E, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(S_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\frac{\beta(t) \totalforceofinfection}{1 + \LambdaIlocagerisktime}\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(E\)</span> to <span class="arithmatex">\(IP\)</span></td>
<td><span class="arithmatex">\(\jointtvarloc_{E \rightarrow IP, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(E_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateEtoI (1 - \propIA)\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(E\)</span> to <span class="arithmatex">\(IA\)</span></td>
<td><span class="arithmatex">\(\jointtvarloc_{E \rightarrow IA, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(E_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateEtoI \propIA\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(IP\)</span> to <span class="arithmatex">\(ISR\)</span></td>
<td><span class="arithmatex">\(\tvarloc_{IP \rightarrow ISR, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(IP_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateIPtoIS \left(1-\frac{\pi^H_{a,r}}{1 + \LambdaHlocagerisktime}\right)\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(IP\)</span> to <span class="arithmatex">\(ISH\)</span></td>
<td><span class="arithmatex">\(\tvarloc_{IP \rightarrow ISH, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(IP_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateIPtoIS \frac{\pi^H_{a,r}}{1 + \LambdaHlocagerisktime}\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(ISR\)</span> to <span class="arithmatex">\(R\)</span></td>
<td><span class="arithmatex">\(\jointtvarloc_{ISR \rightarrow R, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(ISR_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\gamma^{ISR\rightarrow R}\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(ISH\)</span> to <span class="arithmatex">\(HR\)</span></td>
<td><span class="arithmatex">\(\jointtvarloc_{ISH \rightarrow HR, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(ISH_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateISHtoH \left(1-\frac{\pi^D_{a,r}}{1 + \LambdaDlocagerisktime}\right)\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(ISH\)</span> to <span class="arithmatex">\(HD\)</span></td>
<td><span class="arithmatex">\(\jointtvarloc_{ISH \rightarrow HD, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(ISH_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateISHtoH \frac{\pi^D_{a,r}}{1 + \LambdaDlocagerisktime}\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(IA\)</span> to <span class="arithmatex">\(R\)</span></td>
<td><span class="arithmatex">\(\tvarloc_{IA \rightarrow R, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(IA_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateIAtoR\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(HR\)</span> to <span class="arithmatex">\(R\)</span></td>
<td><span class="arithmatex">\(\jointtvarloc_{HR \rightarrow R, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(HR_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateHRtoR\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(HD\)</span> to <span class="arithmatex">\(D\)</span></td>
<td><span class="arithmatex">\(\jointtvarloc_{HD \rightarrow D, a, r}(\simstate)\)</span></td>
<td><span class="arithmatex">\(HD_{a, r}\locationell(t)\)</span></td>
<td><span class="arithmatex">\(\rateHDtoD\)</span></td>
</tr>
</tbody>
</table>
<p>The base count and rate of a transition variable parameterize the distribution that defines its realization. </p>
<p>See <a href="../math_transitions/">this page</a> for mathematical formulations of marginal and joint stochastic transitions between compartments. </p>
<h2 id="general-model-discretized-stochastic-implementation">General model: discretized stochastic implementation</h2>
<p>We make the important note that the flu model's discretized stochastic implementation can be generalized to models with different structures. More broadly, we let <span class="arithmatex">\(\boldsymbol{\mathcal C}(t)\)</span> be a model's set of epidemiological compartments, <span class="arithmatex">\(\boldsymbol{\mathcal M}(t)\)</span> its set of aggregate epidemiological metrics, and <span class="arithmatex">\(\boldsymbol{S (t)}\)</span> its set of schedule-dependent (time-dependent) deterministic values. Then the above formulation still holds.</p>
<p>In fact, in our code, we model <span class="arithmatex">\(\boldsymbol{\mathcal C(t)}\)</span> using an <code>Compartment</code> class, <span class="arithmatex">\(\boldsymbol{\mathcal M}(t)\)</span> using an <code>EpiMetric</code> class, and <span class="arithmatex">\(\boldsymbol{\mathcal S(t)}\)</span> using a <code>Schedule</code> class. We handle stochastic transitions using <code>TransitionVariable</code> and <code>TransitionVariableGroup</code> classes. These classes form some of the building blocks of the base model code. </p>
<blockquote>
<p>Updated 10/06/2025. Documentation written by LP and updated by Rémy Pasco, mathematical notation by LP (advised by Lauren Meyers and Dave Morton, edited by Susan Ptak, Meyers Lab, and Shiyuan Liang), travel model conceptualized by Rémy and Susan Ptak, immunity formulation by Anass Bouchnita.</p>
</blockquote>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.integrate"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>